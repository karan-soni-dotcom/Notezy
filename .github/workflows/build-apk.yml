name: Build Android APK
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create minimal package.json if needed
        run: |
          if [ ! -f "package.json" ]; then
            echo '{"name": "pong-app", "version": "1.0.0", "description": "Pong Game App"}' > package.json
          fi

      - name: Install Capacitor dependencies
        run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android

      - name: Prepare www folder
        run: |
          echo "Cleaning and preparing www/..."
          rm -rf www
          mkdir www

          # Find all top-level html/js/css
          mapfile -t web_files < <(
            find . -maxdepth 1 -type f \( -name '*.html' -o -name '*.js' -o -name '*.css' \)
          )

          if [ ${#web_files[@]} -gt 0 ]; then
            echo "Copying web assets to www/:"
            printf "  - %s\n" "${web_files[@]}"
            cp -- "${web_files[@]}" www/
          else
            echo "⚠️  No .html/.js/.css found at repo root → creating basic index.html"
            cat > www/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Pong App</title>
          </head>
          <body>
            <h1>Pong Game</h1>
            <p>Your game will load here...</p>
          </body>
          </html>
          EOF
          fi

          # Copy assets folder if it exists
          if [ -d assets ]; then
            echo "Copying assets/ → www/assets/"
            cp -r assets www/
          else
            echo "ℹ️  No assets/ directory found, skipping."
          fi

      - name: Initialize Capacitor project
        run: |
          npx cap init "PongApp" "com.example.pong" --web-dir=www

      - name: Add Android platform
        run: |
          echo "Adding Android platform..."
          npx cap add android
          echo "✅ Android platform added successfully"

      - name: Sync Capacitor to Android
        run: npx cap sync android

      - name: Generate Android app icons (fixed)
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

          ICON_SRC=$(find . -maxdepth 2 -type f -name 'app.png' | head -n1 || true)

          if [ -f "$ICON_SRC" ]; then
            echo "Using icon: $ICON_SRC"
          else
            echo "⚠️ app.png not found; creating default placeholder icon."
            mkdir -p temp_icons
            # Create a simple colored square as placeholder
            convert -size 512x512 xc:blue temp_icons/icon.png
            ICON_SRC="temp_icons/icon.png"
          fi

          if [ ! -f "$ICON_SRC" ]; then
            echo "❌ No icon available to resize—skipping icon generation."
          else
            # Remove existing adaptive icon XML files that conflict with PNG generation
            find android/app/src/main/res -name "ic_launcher.xml" -delete 2>/dev/null || true
            find android/app/src/main/res -name "ic_launcher_background.xml" -delete 2>/dev/null || true
            find android/app/src/main/res -name "ic_launcher_foreground.xml" -delete 2>/dev/null || true
            
            # Generate PNG icons for all densities (excluding anydpi-v26 to avoid conflicts)
            for size in 48 72 96 144 192; do
              case $size in
                48)  dir=mipmap-mdpi ;;
                72)  dir=mipmap-hdpi ;;
                96)  dir=mipmap-xhdpi ;;
                144) dir=mipmap-xxhdpi ;;
                192) dir=mipmap-xxxhdpi ;;
              esac
              mkdir -p android/app/src/main/res/$dir
              convert "$ICON_SRC" -resize ${size}x${size} \
                android/app/src/main/res/$dir/ic_launcher.png \
                || echo "⚠️ Failed to generate ${size}×${size} icon; skipping."
            done
            
            # Generate a simple adaptive icon XML for anydpi-v26 that uses the xxxhdpi PNG
            mkdir -p android/app/src/main/res/mipmap-anydpi-v26
            cat > android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@android:color/white"/>
              <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
            
            # Copy the 192px version as foreground for adaptive icon
            cp android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png \
               android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_foreground.png
          fi

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Install Android SDK Tools
        uses: android-actions/setup-android@v3
        with:
          api-levels: 35
          build-tools: '35.0.0'

      - name: Grant execution permissions
        run: chmod +x android/gradlew

      - name: Build Release APK
        run: |
          cd android
          ./gradlew clean assembleRelease

      - name: List generated APK files
        run: |
          echo "Generated APK files:"
          find android/app/build/outputs -name "*.apk" -type f

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pong-app-release.apk
          path: android/app/build/outputs/**/*.apk

      - name: Build Summary
        run: |
          echo "🎉 Build completed successfully!"
          echo "📱 APK files have been uploaded as artifacts"
          echo "💾 Download the APK from the Actions tab to install on your device"
